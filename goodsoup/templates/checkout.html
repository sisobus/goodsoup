{% extends "base.html" %}
{% block content %}
<style>
input[type="radio"] {
    display: inline-block;
}
#gu-col {
    padding: 0px 10px 0px 10px;
}
@media screen and (max-width: 767px) {
    #gu-col {
        padding: 0;
    }
    #si, #gu, #dong {
        margin-bottom: 10px;
    }
}
</style>
<div class="container-fluid title">
    <div class="row">
        <div class="col-sm-12">
            <h2>배송정보</h2>
        </div>
    </div>
</div>

<div class="container-fluid cart-list">
    <div class="row">
        <div class="col-sm-6">
            <form action="#" method="post" novalidate id="order-form" class="myform">
                {% if 'logged_in' in session %}
                <div class="pull-right checkbox" style="margin-top:0px;">
                    <label>
                        <input type="checkbox" id="load_user" name="load_user"> 
                        <span>회원 정보 불러오기
                        </span>
                    </label>
                </div>
                {% endif %}
                <h3 class="text-center" {% if 'logged_in' in session %}style="padding-left:110px;"{% endif %}>배송정보
                </h3>
                
                <div class="row">
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label class="control-label">이름</label>
                            <input id="name" name="name" placeholder="이름" class="form-control" type="text">
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label class="control-label">배송시간</label>
                            <select id="delivery_time" class="form-control">
                                <option selected="selected" value="1차">
                                    1차배송 : 09:00 ~ 12:00
                                </option>
                                <option value="2차">
                                    2차배송 : 15:00 ~ 18:00
                                </option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="local-search" id="local-search">
                        <div class="company-item-region" id="sigudong-search" >
                            <div class="item_box item-region on">
                                <div class="col-sm-4" style="padding:0;">
                                    <select name="si" id="si" class="form-control" tabindex="9">
                                        <option>서울시</option>
                                    </select>
                                </div>
                                <div class="col-sm-4" id="gu-col">
                                    <select name="gu" id="gu" class="form-control" tabindex="9">
                                        <option>전체</option>
                                    </select>
                                </div>
                                <div class="col-sm-4" style="padding:0;">
                                    <select name="dong" id="dong" class="form-control" tabindex="9" >
                                        <option>전체</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label">나머지 주소</label>
                    <input id="address" name="address" placeholder="나머지 주소" class="form-control" type="text" style="margin-top:15px;">
                </div>
                <div class="form-group">
                    <label class="control-label">연락처</label>
                    <input id="phone" name="phone" placeholder="연락처(000-0000-0000 형식만 가능)" class="form-control" type="text">
                </div>
            </form>
            <h4 style="color:red;">주문 유의사항</h4>
            <p style="line-height:1.6;">
             * 오후 7시 이전 주문 완료 시 <span style="color:red;">다음날 배송</span>됩니다
. <br>
            * 오후 7시 이후 주문 완료 시 <span style="color:red;">이틀후</span> 배송됩니다. 
            </p> 
        </div>
        <div class="col-sm-6 ">
            <table class="table">
                <thead>
                    <tr>
                        <th colspan="3" class="text-center">주문 요약 </th>
                    </tr>
                </thead>
                <tbody>
                <tr>
                    <td>가격 :</td>
                    <td></td>
                    <td class="text-right"><b>{{'{:,}'.format(ret.total_price)}}원</b></td>
                </tr>
                <tr>
                    <td>배송비 :</td>
                    <td></td>
                    <td class="text-right">{{'{:,}'.format(ret.delivery_price)}}원</td>
                </tr>
                <tr>
                    <td>부가세 :</td>
                    <td></td>
                    <td class="text-right">0원</td>
                </tr>
                <tr>
                    <td>총 :</td>
                    <td></td>
                    <td id="total" class="text-right">
                        {{ '{:,}'.format(ret.payment_price)}}원
                    </td>
                </tr>
                </tbody>
            </table>
            {% if ret.total_price != 0 %}
            <label><input type="radio" value="card" name="pay_info" checked="checked">신용/체크카드</label>&nbsp;&nbsp;
            <label><input type="radio" value="trans" name="pay_info" >실시간 계좌이체</label>&nbsp;&nbsp;
            <!--
            <label><input type="radio" value="phone" name="pay_info" >휴대폰 결제</label>
            -->
            <br>
            <div id="pay" class="btn btn-right">결제하기</div>
            {% else %}
            <a href="/" class="btn btn-right">장바구니가 비었습니다</a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12 text-center show-more">
            <a href="/" class="btn btn-outline">돌아가기</a>
        </div>
    </div>

</div>
<script type="text/javascript">
function tel_check(s) {
    var re = /^\+?([0-9][0-9][0-9]?)\)?[-]([0-9][0-9][0-9][0-9]?)[-]([0-9]{4})$/;
    var re1 = /^([0-9]{4})[-]([0-9]{4})$/;
    if ( s.match(re) || s.match(re1) ) {
        return true;
    } else {
        return false;
    }
}
    window.state = {};
function bindLocal1(obj) {
        var map = window.state.map;
        var selects = $(".local-search " + obj + " select");
        var local1 = $(selects[0]);
        var local2 = $(selects[1]);
        var local3 = $(selects[2]);
        local1.attr("disabled", false);
        local2.attr("disabled", true);
        local3.attr("disabled", true);
        local1.children().remove();
        var items = window.state.addresses;       
        $(items).each(function (i, item) {
            local1.append($("<option />").text(item.name).val(item.name));
        });
        
    }
    function bindLocal2(obj) {
        var selects = $(".local-search " + obj + " select");
        var local1 = $(selects[0]);
        var local2 = $(selects[1]);
        var local3 = $(selects[2]);
        var v1 = local1.val();
        var node = findNode(v1);
        var option = $("<option />").text("전체");
        local2.children().remove();
//        local2.append(option);
        if (node && node.items) {
            for (var j = 0; j < node.items.length; j++) {
                var item2 = node.items[j];
                var option = $("<option />").text(item2.name);
                local2.append(option);
                local2.attr("disabled", false);
            }
        } else {
            local2.attr("disabled", true);
        }
    }
    function bindLocal3(obj) {
        var selects = $(".local-search " + obj + " select");
        var local1 = $(selects[0]);
        var local2 = $(selects[1]);
        var local3 = $(selects[2]);
        var v1 = local1.val();
        var v2 = local2.val();
        var node = findNode(v1, v2);
        if (node) {
            var option = $("<option />").text("전체");
            local3.children().remove();
            local3.append(option);
        }
        if (node && node.items) {
            for (var j = 0; j < node.items.length; j++) {
                var item2 = node.items[j];
                var option = $("<option />").text(item2.name);
                local3.append(option);
                local3.attr("disabled", false);
            }
        } else {
            var option = $("<option />").text("전체");
            local3.children().remove();
            local3.append(option);
            local3.attr("disabled", true);
        }
        
    }
function findNode(v1, v2, v3) {
        if (v1) {
            var local1s = window.state.addresses;
            for (var i = 0; i < local1s.length; i++) {
                var local1 = local1s[i];
                if (local1.name == v1) {
                    if (v2) {
                        var local2s = local1.items;
                        for (var j = 0; j < local2s.length; j++) {
                            var local2 = local2s[j];
                            if (local2.name == v2) {
                                if (v3) {
                                    var local3s = local2.items;
                                    for (var k = 0; k < local3s.items; k++) {
                                        var local3 = local3s[k];
                                        if (local3 == v3) {
                                            return local3;
                                        }
                                    }
                                    return null;
                                }
                                return local2;
                            }
                        }
                        return null;
                    }
                    return local1;
                }
            }
        }
        return null;
    }
function initLocalSearch() {
    var items = $(".local-search .company-item-region select");
        var local1 = $(items[0]);
        local1.children().remove();
        local1.append($("<option />").text("로딩 중"))
        local1.attr("disabled", true);
        local1.change(function () {
            bindLocal2(".company-item-region");
            bindLocal3(".company-item-region");
        });
        var local2 = $(items[1]);
        local2.attr("disabled", true);
        local2.change(function () {
            bindLocal3(".company-item-region");
        });
        var local3 = $(items[2]);
        local3.attr("disabled", true);
        $.when(
             $.ajax({
                 url: "/json/20161129"
             })
        ).done(function (data) {
            data = data.results;
            var new_data = [];
            for ( var i = 0 ; i < data.length ; i++ ) 
            new_data.push(data[i]);
            /*
            new_data.push(data[8]);
            new_data.push(data[1]);
            new_data.push(data[11]);
            new_data.push(data[7]);
            new_data.push(data[5]);
            new_data.push(data[6]);
            new_data.push(data[10]);
            new_data.push(data[9]);
            new_data.push(data[4]);
            new_data.push(data[0]);
            new_data.push(data[16]);
            new_data.push(data[15]);
            new_data.push(data[3]);
            new_data.push(data[2]);
            new_data.push(data[13]);
            new_data.push(data[12]);
            new_data.push(data[14]);
            */
            window.state.addresses = new_data
            bindLocal1(".company-item-region");
            bindLocal2(".company-item-region");
            bindLocal3(".company-item-region");
            $(".item_submit").removeAttr("disabled");
        });
    $(".local-search .company-item-region button").click(function () {
        var selects = $(".local-search .company-item-region select");
        var local1 = $(selects[0]);
        var local2 = $(selects[1]);
        var local3 = $(selects[2]);
        var selected = !local3.is(":disabled") ? local3.find("option:selected") : local2.find("option:selected");
        var lat = selected.data("lat");
        var lng = selected.data("lng");
        var zoom = 20 - parseInt(selected.data("zoom"));
        location.href = "/search/map?lat=" + lat + "&lng=" + lng + "&zoom="+ zoom;
    });
}
$(document).ready(function() {
    IMP.init('imp27079569');
    initLocalSearch();
    $('#phone').change(function() {
        var tel = $(this).val();
        if ( tel_check(tel) ) {
            $(this).css('border','1px solid #ccc');
        } else {
            $(this).val('');
            $(this).css('border','2px solid red');
        }
    });
    $('#load_user').change(function() {
        if ( this.checked ) {
            $('#name').val("{{session['username']}}");
            $('#phone').val("{{session['tel']}}");
            if ( "{{session['si']}}" == "경기도" ) {
                if ( "{{session['gu']}}" == "수원시 권선구" ) {
                    $("#gu").val("수원시 권선구").attr("selected","selected");
                    bindLocal3(".company-item-region");
                    $("#address").val("{{session['address']}}").attr("selected","selected");
                } else if ( "{{session['gu']}}" == "수원시 영통구" ) {
                    $("#gu").val("수원시 영통구").attr("selected","selected");
                    bindLocal3(".company-item-region");
                    $("#address").val("{{session['address']}}").attr("selected","selected");
                } else if ( "{{session['gu']}}" == "용인시 기흥구" ) {
                    $("#gu").val("용인시 기흥구").attr("selected","selected");
                    bindLocal3(".company-item-region");
                    $("#address").val("{{session['address']}}").attr("selected","selected");
                } else if ( "{{session['gu']}}" == "화성시" ) {
                    $("#gu").val("화성시").attr("selected","selected");
                    bindLocal3(".company-item-region");
                    $("#address").val("{{session['address']}}").attr("selected","selected");
                }
            }
        }
    });
});
$('#pay').click(function() {
    var checked_pay_method = $("input[name=pay_info]:checked").val();
    var delivery_time   = $("#delivery_time").val();
    {% if ret.soups|length != 0 %}
    var pay_name = "{{ret.soups[0].name}} 포함 총 {{ret.total_cnt}}개의 국";
    {% endif %}
    var _buyer_name  = $('#name').val();
    var _buyer_si    = $('#si').val();
    var _buyer_gu    = $('#gu').val();
    var _buyer_dong  = $('#dong').val();
    var _buyer_address = $('#address').val();
    var _total_address = _buyer_si + " " + _buyer_gu + " " + _buyer_dong + " " + _buyer_address;
    var _buyer_tel   = $('#phone').val();

    if ( _buyer_name == "" ) {
        alert('이름을 작성해주세요');
        return;
    } 
    if ( _buyer_address == "" ) {
        alert('나머지 주소를 작성해주세요');
        return;
    }
    if ( _buyer_tel == "" ) {
        alert('연락처를 작성해주세요');
        return;
    }
    if ( _buyer_dong == "전체" ) {
        alert('동을 선택해주세요');
        return;
    } 
    _custom_data = { delivery_time : delivery_time };

    IMP.request_pay({
        pg : 'html5_inicis',
        pay_method : checked_pay_method,
        merchant_uid : 'merchant_' + new Date().getTime(),
        name : pay_name,
        amount : {{ret.payment_price}},
        {% if 'logged_in' in session %}
        buyer_email : '{{ session['email'] }}',
        {% endif %}
        buyer_name : _buyer_name,
        buyer_tel : _buyer_tel,
        buyer_addr : _total_address,
        custom_data : _custom_data,
        m_redirect_url : 'http://www.goodsoup.co.kr/mpayments/complete'
    }, function(rsp) {
        if ( rsp.success ) {
            $.ajax({
                url: "/payments/complete",
                type: 'POST',
                dataType: 'json',
                data: {
                    imp_uid : rsp.imp_uid
                }
            }).done(function(data) {
                console.log(data);
                if ( data['success'] ) {
                    var msg = '결제가 완료되었습니다.';
                    msg += '고유ID : ' + rsp.imp_uid;
                    msg += '상점 거래ID : ' + rsp.merchant_uid;
                    msg += '결제 금액 : ' + rsp.paid_amount;
                    msg += '카드 승인번호 : ' + rsp.apply_num;
                    console.log(msg);
                    window.location.href = "/payment_result/"+data['imp_uid'];
                } else {
                    console.log('[3] 아직 제대로 결제가 되지 않았습니다.');
                    alert('결제된 금액이 요청한 금액과 달라 결제를 자동취소처리하였습니다');
                //[3] 아직 제대로 결제가 되지 않았습니다.
                //[4] 결제된 금액이 요청한 금액과 달라 결제를 자동취소처리하였습니다.
                }
            });
        } else {
            var msg = '결제에 실패하였습니다.';
            msg += '에러내용 : ' + rsp.error_msg;
            alert(msg);
        }
    });
});
</script>
{% endblock %}
